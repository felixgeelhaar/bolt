name: Release with GoReleaser

# This is an alternative release workflow using GoReleaser
# Enable by commenting out the simple release.yml workflow
# and uncommenting this one in your workflow triggers

on:
  push:
    tags:
      - 'v*'
    # Uncomment to enable this workflow
    # branches:
    #   - never  # This prevents it from running unless explicitly enabled

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: read

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.23'
          cache: true

      - name: Validate version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          
          # Check module path for v2+
          if [ "$MAJOR" != "v1" ] && [ "$MAJOR" != "v0" ]; then
            MODULE_PATH=$(grep "^module " go.mod | cut -d' ' -f2)
            if [[ ! "$MODULE_PATH" == *"/$MAJOR" ]]; then
              echo "Error: Module path must include /$MAJOR for versions > v1"
              exit 1
            fi
          fi

      - name: Run tests
        run: |
          go test -v -race -short -coverprofile=coverage.txt ./...
          go test -bench=. -benchmem -run=^$
          rm -f coverage.txt

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Warm module proxy
        continue-on-error: true
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          MAJOR=$(echo $VERSION | cut -d. -f1)

          if [ "$MAJOR" = "v0" ] || [ "$MAJOR" = "v1" ]; then
            MODULE="github.com/${{ github.repository }}"
          else
            MODULE="github.com/${{ github.repository }}/$MAJOR"
          fi

          # Warm up the module proxy (these are essential)
          curl -sf "https://proxy.golang.org/${MODULE}/@v/${VERSION}.info" || echo "⚠️ Failed to warm .info"
          curl -sf "https://proxy.golang.org/${MODULE}/@v/${VERSION}.mod" || echo "⚠️ Failed to warm .mod"
          curl -sf "https://proxy.golang.org/${MODULE}/@v/${VERSION}.zip" || echo "⚠️ Failed to warm .zip"

          # Trigger pkg.go.dev indexing (may fail initially, that's ok)
          curl -s "https://pkg.go.dev/${MODULE}@${VERSION}" > /dev/null || echo "⚠️ pkg.go.dev not yet indexed"

          echo "✅ Module proxy warming complete for ${MODULE}@${VERSION}"